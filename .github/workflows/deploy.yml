name: Lint and Deploy

on:
  push:
    branches:
      - master

jobs:
  lint:
    runs-on: ubuntu-latest

    steps:
      # 1. Клонирование репозитория
      - name: Checkout code
        uses: actions/checkout@v3

      # 2. Установка Poetry через скрипт
      - name: Install Poetry
        run: |
          curl -sSL https://install.python-poetry.org | python3 -
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      # 3. Установка зависимостей
      - name: Install dependencies
        run: |
          poetry install

      # 4. Запуск линтера
      - name: Run linter (flake8)
        run: |
          poetry run flake8 .

deploy:
  runs-on: ubuntu-latest
  needs: lint

  steps:
    # 1. Клонирование репозитория
    - name: Checkout code
      uses: actions/checkout@v3

    # 2. Настройка SSH-доступа
    - name: Set up SSH
      uses: webfactory/ssh-agent@v0.8.1
      with:
        ssh-private-key: ${{ secrets.DEPLOY_KEY }}

    # 3. Деплой на сервер
    - name: Deploy to Server
      run: |
        ssh -o StrictHostKeyChecking=no perceptor@45.132.107.67 << 'EOF'
        set -e

        echo "Перехожу в директорию проекта..."
        cd /home/perceptor/projects/tg_budget

        echo "Обновляю код из репозитория..."
        git pull origin master

        echo "Останавливаю старые контейнеры..."
        docker-compose down

        echo "Собираю и запускаю новые контейнеры..."
        docker-compose up --build -d

        echo "Удаляю старые Docker-образы..."
        docker image prune -f

        EOF
